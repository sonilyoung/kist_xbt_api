<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.stu.learning.dao.LearningDAO">
	
	
	<!-- 차수정보가져오기 -->
	<select id="selectBaseline" parameterType="egovframework.com.stu.learning.vo.Learning" resultType="egovframework.com.stu.learning.vo.Learning">
		SELECT 
			T1.PROC_CD ,
			T1.PROC_YEAR ,
			T1.PROC_SEQ ,
			T1.EDU_START_DATE ,
			T1.EDU_END_DATE 
		FROM XBT_BASELINE T1 INNER JOIN XBT_BASELINE_STUDENT_INFO T2
		ON T1.PROC_CD = T2.PROC_CD 
		AND T1.PROC_YEAR = T2.PROC_YEAR 
		AND T1.PROC_SEQ = T2.PROC_SEQ 
		AND T2.USER_ID = #{userId}
		AND NOW() BETWEEN EDU_START_DATE AND EDU_END_DATE		 
	</select>	
	
	<!-- 사용자교육정보가져오기 -->
	<select id="selectLearning" parameterType="egovframework.com.stu.learning.vo.Learning" resultType="egovframework.com.stu.learning.vo.Learning">	
		SELECT 
			DAY_NO ,
			PROC_CD ,
			PROC_NM ,
			MENU_CD ,
			MENU_NM ,
			MODULE_ID ,
			MODULE_TYPE ,
			EDU_TYPE ,
			USER_ID ,
			EDU_DATE 
		FROM XBT_BASELINE_EDU_DATE 
		WHERE MODULE_ID IS NOT NULL 
		AND EDU_TYPE = #{eduType} 
		AND USER_ID = #{userId} 
		AND PROC_CD = #{procCd}
	</select>
	
	<!-- 사용자교육모듈정보 -->
	<select id="selectModuleInfo" parameterType="egovframework.com.stu.learning.vo.Learning" resultType="egovframework.com.stu.learning.vo.Learning">			
		SELECT 
			MODULE_ID ,
			MODULE_NM ,
			QUESTION_CNT ,
			TIME_LIMIT ,
			STUDY_LVL ,
			MODULE_TYPE ,
			SLIDE_SPEED 
		FROM XBT_MODULE_INFO_MASTER
		WHERE MODULE_ID = 
		(
			SELECT MODULE_ID  
			FROM XBT_BASELINE_EDU_DATE 
			WHERE MODULE_ID IS NOT NULL 
			AND EDU_TYPE =  #{eduType} 
			and USER_ID = #{userId}  
			AND PROC_CD = #{procCd}
		 )	
	</select>
	
	
	<!-- 학습문제조회 -->
	<select id="selectLearningProblems" parameterType="egovframework.com.stu.learning.vo.LearningProblem" resultType="egovframework.com.stu.learning.vo.LearningProblem">			
		SELECT 
			MODULE_ID,
			STUDY_LVL,
			BAG_SCAN_ID ,
			ACTION_DIV ,
			ACTION_DIV_NAME	
		FROM XBT_MODULE_INFO_DETAIL WHERE MODULE_ID  = #{moduleId}
	</select>
	
	<!-- 등록된학습문제 체크 -->
	<select id="selectLearningProblemsCount" parameterType="egovframework.com.stu.learning.vo.LearningProblem" resultType="int">
		SELECT 
			COUNT(PROGRESS_NO) 
		FROM XBT_STU_LEARNING_PROGRESSING
		WHERE PROC_CD = #{procCd} 
		AND PROC_YEAR = #{procYear} 
		AND PROC_SEQ = #{procSeq}
		AND USER_ID = #{userId}
	</select>
	
	<!-- 학습문제 등록 -->
	<insert id="insertLearningProblems" parameterType="egovframework.com.stu.learning.vo.LearningProblem">
		INSERT INTO XBT_STU_LEARNING_PROGRESSING(
		MODULE_ID, 
		PROC_CD, 
		PROC_YEAR, 
		PROC_SEQ, 
		USER_ID,
		BAG_SCAN_ID, 
		ACTION_DIV, 
		INSERT_DATE)
		SELECT 
			MODULE_ID,
			#{procCd},
			#{procYear},
			#{procSeq},
			#{userId},
			BAG_SCAN_ID ,
			ACTION_DIV ,
			NOW()
		FROM XBT_MODULE_INFO_DETAIL WHERE MODULE_ID  = #{moduleId}
	</insert>		
	
	
	<!-- 학습문제 초기화-->
	<update id="updateLearningProblems" parameterType="egovframework.com.stu.learning.vo.LearningProblem">	
		UPDATE 
			XBT_BASELINE_LEARNING 
		SET END_YN = 'N'
		WHERE PROC_CD = #{procCd} 
		AND PROC_YEAR = #{procYear} 
		AND PROC_SEQ = #{procSeq}
		AND USER_ID = #{userId}
	</update>		
	
	<!-- 학습문제출제목록가져오기 -->
	<select id="selectLearnProblemsList" parameterType="egovframework.com.stu.learning.vo.LearningProblem" resultType="egovframework.com.stu.learning.vo.LearningProblem">			
		SELECT 
			MODULE_ID, 
			PROC_CD, 
			PROC_YEAR, 
			PROC_SEQ, 
			USER_ID,
			BAG_SCAN_ID, 
			ACTION_DIV, 
			INSERT_DATE
		FROM XBT_STU_LEARNING_PROGRESSING 
		WHERE PROC_CD = #{procCd} 
		AND PROC_YEAR = #{procYear} 
		AND PROC_SEQ = #{procSeq}
		AND USER_ID = #{userId}
		AND END_YN = 'N'
	</select>	
	
	<!-- 학습정답확인 -->
	<select id="selectLearnAnswer" parameterType="egovframework.com.stu.learning.vo.Learning" resultType="egovframework.com.stu.learning.vo.Learning">
		SELECT ACTION_DIV = #{userActionDiv} as answer 
		FROM XBT_STU_LEARNING_PROGRESSING 
		WHERE 
		MODULE_ID = #{moduleId} 
		and PROC_CD = #{procCd}  
		AND PROC_YEAR = #{procYear} 
		AND PROC_SEQ = #{procSeq}
		AND USER_ID = #{userId}
		AND BAG_SCAN_ID = #{bagScanId}
		AND END_YN = 'N'
	</select>		
	
	
	<!-- 학습정답선택-->
	<update id="updateLeanAnswer" parameterType="egovframework.com.stu.learning.vo.Learning">	
		UPDATE 
			XBT_BASELINE_LEARNING 
		SET 
			USER_ACTION_DIV = #{userActionDiv},
			GAIN_SCORE = #{gainScore}
		WHERE PROC_CD = #{procCd} 
		AND PROC_YEAR = #{procYear} 
		AND PROC_SEQ = #{procSeq}
		AND USER_ID = #{userId}
		AND BAG_SCAN_ID = #{bagScanId}
	</update>		
	
</mapper>